<img src="https://oasislmf.org/packages/oasis_theme_package/themes/oasis_theme/assets/src/oasis-lmf-colour.png" alt="Oasis LMF logo" width="250"/>

[![Binder](https://mybinder.org/badge.svg)](https://mybinder.org/v2/gh/OasisLMF/OasisPiWind/master)
[![PiWind Testing](https://github.com/OasisLMF/OasisPiWind/actions/workflows/test.yml/badge.svg?branch=master)](https://github.com/OasisLMF/OasisPiWind/actions/workflows/test.yml)
[![PiWind MDK](https://github.com/OasisLMF/OasisPiWind/actions/workflows/run_mdk.yml/badge.svg?branch=master)](https://github.com/OasisLMF/OasisPiWind/actions/workflows/run_mdk.yml)

# Oasis PiWind
Toy UK windstorm model.

## Cloning the repository

You can clone this repository from <a href="https://github.com/OasisLMF/OasisPiWind" target="_blank">GitHub</a>.

## Running via the Oasis MDK

The <a href="https://pypi.org/project/oasislmf/" target="_blank">Oasis model development kit (MDK)</a> is a Python package which provides a command line interface (CLI) for developing and running models using the Oasis framework. It can be installed via the Python package installer `pip` (or `pip3` for Python 3). The PiWind repository contains a <a href="https://github.com/OasisLMF/OasisPiWind/blob/master/oasislmf.json" target="_blank">JSON configuration file</a> that allows the PiWind model to be run via the MDK.

Using the configuration file an end-to-end analysis can be executed using the command:

	oasislmf model run -C oasislmf.json

Files will be generated by default in a UTC timestamped folder named `runs/ProgOasis-<UTC timestamp`> in your working directory.

## Aggregate footprint model feature

The model contains event footprints at postal code resolution (full 7 character postcode only) as well as grid cell resolution.

The original hazard intensity footprint by grid cell (10 x 10) was generated with a single hazard intensity value by event and by cell, i.e. there is no hazard uncertainty. 

The postcode footprint has been generated from the grid cell footprint with hazard intensity uncertainty using some information about the built environment, specifically, a list of all known buildings with addresses and occupancy codes in the OED location file tests/inputs/SourceLocOEDPiWind.csv.

The process followed was;

1. Run the OED location file representing the built environment through the key server to get a list of grid cell areaperils for each location.

2. For each postcode appearing in the OED location file, count the number of buildings assigned to each grid cell areaperil.

3. Create a new range of areaperils for the list of represented postcodes for each peril (201-724 for WTC and 725 to 1248 for WSS).

4. For each event footprint, create a new event footprint for the postcode areaperils by looking up the grid cell areaperils and intensity_bins for the postcode areaperil and using the building counts in step 2 as weights for the intensity_bin probability.

5. Append the postcode footprint to the grid cell footprint and sort by event_id, areaperil_id, intensity_bin_id.


## Weighted vulnerability model feature

This version of PiWind has 4 extra vulnerability functions, with ids 13-16 representing an unknown occupancy type for the 4 combinations of peril and coverage.

| vulnerability_id | peril    | coverage_type   | occupancy code   |
|:-----------------|----------|-----------------| ----------------:|
|       13         | WTC      |    1            | 1000             |
|       14         | WTC      |    3            | 1000             |
|       15         | WSS      |    1            | 1000             |
|       16         | WSS      |    3            | 1000             |


These are listed in the vulnerability dictionary.

When a location has OccupancyCode = 1000 (unknown), instead of it being matched with a default detailed vulnerability function, it is matched with one of the new aggregate vulnerability_ids and a weighted average of vulnerability functions is computed dynamically depending on its areaperil.

The weightings have been derived from some information about the built environment, specifically a list of all known buildings with addresses and occupancy codes in the OED location file tests/inputs/SourceLocOEDPiWind.csv.

The process followed was;

1. Run the OED location file representing the built environment through the key server to get a list of vulnerability_ids for each location.

2. Group by areaperil_id and vulnerability_id and count the number of locations. This data is used to create the required weights file.

3. For any missing areaperil_ids from this list (ie grid cells with no buildings in the built environment data) a default vulnerability id was assigned with weight 1, to prevent errors from occurring. This list was appended to the weights file.

The weightings are represented in the model data as two extra files;

1) **aggregate_vulnerability** which contains the mapping from aggregate vulnerability ids 13-16 to detailed vulnerability ids 1-12 
2) **weights** which contain the weights of detailed vulnerability ids within each grid cell (areaperil_id). The numbers are integers representing the count of buildings from which relative weights can be derived.

There is no need to pre-generate vulnerability functions 13-16 because the weightings are applied on-the-fly during the analysis. Therefore the vulnerability file does not change.

In order to make use of this feature, the full Monte Carlo sampling approach (calculation component 'gulmc') must be used. This can be specified in the oasislmf.json file as follows;

```
    "modelpy": true,
    "gulmc": true,
    "gulpy": false
```